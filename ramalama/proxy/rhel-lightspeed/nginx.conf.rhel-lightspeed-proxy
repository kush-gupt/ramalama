# Nginx configuration for RHEL Lightspeed Proxy

# Run as the user specified in the Containerfile (e.g., 1001)
# The 'user' directive is usually set here if nginx needs to drop root privileges,
# but if started as non-root, it inherits that user.
# Ensure pid path is writable by this user.
pid /var/run/nginx/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Important: Do not buffer responses from the backend.
    # This is crucial for streaming APIs like those used by LLMs.
    proxy_buffering off;
    proxy_request_buffering off; # Also for requests if they can be large/streamed

    server {
        listen ${PROXY_LISTEN_PORT};
        server_name localhost; # Or a specific server name if needed

        location / {
            # These variables are substituted by envsubst at container startup
            proxy_pass https://${LIGHTSPEED_ENDPOINT_HOST}:${LIGHTSPEED_ENDPOINT_PORT};

            # Client certificate for authenticating to the RHEL Lightspeed endpoint
            # These paths should have the certs available at runtime via host volume mounts.
            proxy_ssl_certificate /etc/pki/consumer/cert.pem;
            proxy_ssl_certificate_key /etc/pki/consumer/key.pem;

            # Recommended for security and compatibility
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_ciphers HIGH:!aNULL:!MD5; # Modern cipher suite
            proxy_ssl_server_name on; # Enable SNI
            proxy_ssl_verify on; # Verify the Lightspeed endpoint's server certificate
            # If the Lightspeed server's CA is not in the container's default trust store,
            # you might need: proxy_ssl_trusted_certificate /path/to/ca.pem;

            # Standard proxy headers to forward client information
            proxy_set_header Host $proxy_host; # Use the host from the proxy_pass directive.
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection ''; # Clear Connection header if client sends 'close'

            # Adjust timeouts if necessary
            proxy_connect_timeout 75s;
            proxy_send_timeout 300s;  # Potentially long for LLM requests
            proxy_read_timeout 300s;   # Potentially long for LLM responses
        }
    }
}
